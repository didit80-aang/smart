<!doctype html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Control - ESP8266</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #22c55e;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab.active {
            background: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-3px);
        }

        .relay-card {
            display: flex;
            flex-direction: column;
        }

        .relay-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .relay-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: all 0.3s;
        }

        .relay-icon.on {
            background: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        .relay-icon.off {
            background: #6b7280;
        }

        .relay-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .relay-label {
            color: #93c5fd;
            font-size: 0.85rem;
        }

        .relay-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        .btn-edit {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #93c5fd;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .btn-edit:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-on {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .btn-on:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-off {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-off:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .sensor-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sensor-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .sensor-icon.temp {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .sensor-icon.humid {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .sensor-value {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1;
            margin: 5px 0;
        }

        .sensor-label {
            color: #93c5fd;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 25px;
            margin-top: 20px;
            height: 380px;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: calc(100% - 30px);
            margin-top: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #93c5fd;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .schedule-list {
            margin-top: 20px;
        }

        .schedule-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .schedule-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .schedule-info {
            flex: 1;
        }

        .schedule-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-icon:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
        }

        .day-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .day-btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
            color: #93c5fd;
        }

        .day-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .day-btn:hover {
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #93c5fd;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .info-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .info-card h3 {
            color: #93c5fd;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .info-card p {
            color: #cbd5e1;
            line-height: 1.6;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-icon {
            font-size: 36px;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #93c5fd;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px;
                text-align: center;
                justify-content: center;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }

            .tabs {
                justify-content: center;
            }

            .tab {
                padding: 10px 18px;
                font-size: 14px;
            }
            
            .chart-container {
                padding: 20px;
                height: 350px;
            }
            
            .sensor-value {
                font-size: 1.8rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .chart-container {
                height: 320px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üè† Smart Home Control</h1>
                <p style="color: #93c5fd;">ESP8266 IoT Controller</p>
            </div>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Terputus</span>
            </div>
        </div>
        <div class="tabs">
            <button class="tab active" data-tab="control">‚ö° Kontrol</button>
            <button class="tab" data-tab="schedule">üïê Jadwal</button>
            <button class="tab" data-tab="monitor">üìä Monitoring</button>
            <button class="tab" data-tab="settings">‚öôÔ∏è Pengaturan</button>
            <button class="tab" data-tab="info">‚ÑπÔ∏è Info</button>
        </div>
        
        <div id="control" class="tab-content active">
            <div class="grid" id="relayGrid"></div>
        </div>
        
        <div id="schedule" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="font-size: 1.3rem;">Jadwal Otomatis</h2>
                    <button class="btn-primary" onclick="showScheduleModal()">‚ûï Tambah Jadwal</button>
                </div>
                <div id="scheduleList" class="schedule-list"></div>
            </div>
        </div>
        
        <div id="monitor" class="tab-content">
            <div class="grid">
                <div class="card sensor-card">
                    <div class="sensor-icon temp">üå°Ô∏è</div>
                    <div>
                        <div class="sensor-label">Suhu Ruangan</div>
                        <div class="sensor-value" id="tempValue">--¬∞C</div>
                    </div>
                </div>
                <div class="card sensor-card">
                    <div class="sensor-icon humid">üíß</div>
                    <div>
                        <div class="sensor-label">Kelembaban</div>
                        <div class="sensor-value" id="humidValue">--%</div>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <h3 style="margin-bottom: 10px; font-size: 1.2rem;">Grafik Suhu & Kelembaban</h3>
                <div class="chart-wrapper">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="settings" class="tab-content">
            <div class="card">
                <h2 style="font-size: 1.3rem; margin-bottom: 20px;">‚öôÔ∏è Pengaturan Relay</h2>
                <div class="form-group">
                    <label class="form-label">Relay 1</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="relay1Name" class="form-input" value="Lampu Ruang Tamu" maxlength="30">
                        <button class="btn btn-success" onclick="saveRelayName(1)">üíæ Simpan</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Relay 2</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="relay2Name" class="form-input" value="Lampu Kamar" maxlength="30">
                        <button class="btn btn-success" onclick="saveRelayName(2)">üíæ Simpan</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Relay 3</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="relay3Name" class="form-input" value="AC" maxlength="30">
                        <button class="btn btn-success" onclick="saveRelayName(3)">üíæ Simpan</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Relay 4</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="relay4Name" class="form-input" value="Kipas Angin" maxlength="30">
                        <button class="btn btn-success" onclick="saveRelayName(4)">üíæ Simpan</button>
                    </div>
                </div>
                <div class="btn-group" style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="saveAllRelayNames()">üíæ Simpan Semua Nama</button>
                    <button class="btn btn-secondary" onclick="resetRelayNames()">‚Ü∫ Reset ke Default</button>
                </div>
            </div>
            <div class="card info-card">
                <div class="info-icon">üí°</div>
                <h3>Informasi Kustomisasi</h3>
                <p><strong>Fitur:</strong></p>
                <p>‚Ä¢ Ubah nama relay sesuai kebutuhan Anda</p>
                <p>‚Ä¢ Nama akan disimpan di ESP8266 EEPROM</p>
                <p>‚Ä¢ Nama akan muncul di semua tampilan</p>
                <p>‚Ä¢ Nama digunakan juga di jadwal otomatis</p>
            </div>
        </div>
        
        <div id="info" class="tab-content">
            <div class="card info-card">
                <div class="info-icon">üè†</div>
                <h3>Informasi Sistem</h3>
                <p><strong>Nama Relay (Dapat Dikustomisasi):</strong></p>
                <p id="infoRelayNames">Loading...</p>
            </div>
            <div class="card info-card">
                <div class="info-icon">‚öôÔ∏è</div>
                <h3>Cara Menggunakan</h3>
                <p><strong>Kontrol Manual:</strong> Klik tombol pada relay untuk menyalakan/mematikan perangkat.</p>
                <p><strong>Jadwal Otomatis:</strong> Atur jadwal untuk menyalakan/mematikan perangkat secara otomatis.</p>
                <p><strong>Kustomisasi:</strong> Ubah nama relay di tab "Pengaturan".</p>
                <p><strong>Monitoring:</strong> Pantau suhu dan kelembaban ruangan secara real-time.</p>
            </div>
            <div class="card info-card">
                <div class="info-icon">üì°</div>
                <h3>Koneksi MQTT</h3>
                <p><strong>Broker:</strong> broker.hivemq.com:8884</p>
                <p><strong>Topic Prefix:</strong> adit80/smartcontrol</p>
                <p><strong>Status:</strong> <span id="mqttStatusText">Menghubungkan...</span></p>
            </div>
        </div>
    </div>
    
    <!-- Modal Jadwal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeScheduleModal()">√ó</button>
            <h2 class="modal-header">Tambah Jadwal Baru</h2>
            <div class="form-group">
                <label class="form-label">Relay</label>
                <select id="scheduleRelay" class="form-input">
                    <option value="1">Relay 1</option>
                    <option value="2">Relay 2</option>
                    <option value="3">Relay 3</option>
                    <option value="4">Relay 4</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Jam</label>
                    <input type="number" id="scheduleHour" class="form-input" min="0" max="23" value="6">
                </div>
                <div class="form-group">
                    <label class="form-label">Menit</label>
                    <input type="number" id="scheduleMinute" class="form-input" min="0" max="59" value="0">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Aksi</label>
                <select id="scheduleAction" class="form-input">
                    <option value="1">Nyalakan</option>
                    <option value="0">Matikan</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Hari</label>
                <div class="day-buttons" id="dayButtons">
                    <button type="button" class="day-btn active" onclick="toggleDay(0)">Min</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(1)">Sen</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(2)">Sel</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(3)">Rab</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(4)">Kam</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(5)">Jum</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(6)">Sab</button>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveSchedule()">üíæ Simpan</button>
                <button class="btn btn-secondary" onclick="closeScheduleModal()">‚ùå Batal</button>
            </div>
        </div>
    </div>
    
    <script>
        // ========== VARIABEL GLOBAL ==========
        let mqttClient = null;
        let connected = false;
        
        let relays = [
            { id: 1, name: 'Lampu Ruang Tamu', status: false },
            { id: 2, name: 'Lampu Kamar', status: false },
            { id: 3, name: 'AC', status: false },
            { id: 4, name: 'Kipas Angin', status: false }
        ];
        
        let schedules = [];
        let tempData = [];
        let humidData = [];
        let tempChart = null;
        let selectedDays = 127;

        const MQTT_BROKER = 'wss://broker.hivemq.com:8884/mqtt';
        const TOPIC_PREFIX = 'adit80/smartcontrol';

        // ========== FUNGSI MQTT ==========
        
        function initMQTT() {
            try {
                updateMqttStatus('Menghubungkan...');
                
                mqttClient = mqtt.connect(MQTT_BROKER, {
                    clientId: 'smartcontrol_' + Math.random().toString(16).substr(2, 8),
                    clean: true,
                    reconnectPeriod: 5000
                });

                mqttClient.on('connect', () => {
                    console.log('‚úÖ Connected to MQTT broker');
                    connected = true;
                    updateConnectionStatus(true);
                    updateMqttStatus('Terhubung');

                    mqttClient.subscribe(`${TOPIC_PREFIX}/status`);
                    mqttClient.subscribe(`${TOPIC_PREFIX}/temperature`);
                    mqttClient.subscribe(`${TOPIC_PREFIX}/humidity`);
                    mqttClient.subscribe(`${TOPIC_PREFIX}/scheduler`);
                    mqttClient.subscribe(`${TOPIC_PREFIX}/relaynames`);

                    setTimeout(() => {
                        mqttClient.publish(`${TOPIC_PREFIX}/requestnames`, 'request');
                    }, 500);
                });

                mqttClient.on('message', (topic, message) => {
                    handleMessage(topic, message.toString());
                });

                mqttClient.on('error', (err) => {
                    console.error('‚ùå MQTT Error:', err);
                    connected = false;
                    updateConnectionStatus(false);
                    updateMqttStatus('Error: ' + err.message);
                });

                mqttClient.on('close', () => {
                    connected = false;
                    updateConnectionStatus(false);
                    updateMqttStatus('Terputus');
                });

                mqttClient.on('reconnect', () => {
                    console.log('üîÑ Reconnecting to MQTT...');
                    updateMqttStatus('Menyambung ulang...');
                });
            } catch (err) {
                console.error('‚ùå Failed to initialize MQTT:', err);
                updateMqttStatus('Gagal menghubungkan');
            }
        }

        function handleMessage(topic, message) {
            console.log(`üì® MQTT Message: ${topic} -> ${message}`);
            
            if (topic === `${TOPIC_PREFIX}/status`) {
                const states = message.split(',');
                relays.forEach((relay, i) => {
                    if (i < states.length) {
                        relay.status = states[i] === '1';
                    }
                });
                renderRelays();
            }
            else if (topic === `${TOPIC_PREFIX}/temperature`) {
                const temp = parseFloat(message);
                if (!isNaN(temp)) {
                    document.getElementById('tempValue').textContent = temp.toFixed(1) + '¬∞C';
                    addTempData(temp);
                }
            }
            else if (topic === `${TOPIC_PREFIX}/humidity`) {
                const humid = parseFloat(message);
                if (!isNaN(humid)) {
                    document.getElementById('humidValue').textContent = humid.toFixed(1) + '%';
                    addHumidData(humid);
                }
            }
            else if (topic === `${TOPIC_PREFIX}/scheduler`) {
                try {
                    const data = JSON.parse(message);
                    if (data.schedules && Array.isArray(data.schedules)) {
                        schedules = data.schedules.map((s, i) => ({
                            id: Date.now() + i,
                            enabled: s.enabled !== undefined ? s.enabled : true,
                            relay: s.relay,
                            hour: s.hour,
                            minute: s.minute,
                            action: s.action,
                            days: s.days
                        }));
                        renderSchedules();
                    }
                } catch (e) {
                    console.error('‚ùå Error parsing scheduler:', e);
                }
            }
            else if (topic === `${TOPIC_PREFIX}/relaynames`) {
                try {
                    const data = JSON.parse(message);
                    if (data.names && Array.isArray(data.names)) {
                        relays.forEach((relay, i) => {
                            if (data.names[i]) {
                                relay.name = data.names[i];
                            }
                        });
                        
                        updateRelayNameInputs();
                        renderRelays();
                        updateInfoTab();
                        console.log('‚úÖ Relay names updated:', relays);
                    }
                } catch (e) {
                    console.error('‚ùå Error parsing relay names:', e);
                }
            }
        }

        function updateConnectionStatus(isConnected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            if (isConnected) {
                dot.classList.add('connected');
                text.textContent = 'Terhubung';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Terputus';
            }
        }

        function updateMqttStatus(status) {
            const statusElement = document.getElementById('mqttStatusText');
            if (statusElement) {
                statusElement.textContent = status;
            }
        }

        // ========== FUNGSI KUSTOMISASI NAMA RELAY ==========
        
        function saveRelayName(relayId) {
            if (!connected) {
                alert('‚ö†Ô∏è Tidak terhubung ke MQTT broker!');
                return;
            }
            
            const input = document.getElementById(`relay${relayId}Name`);
            const newName = input.value.trim();
            
            if (newName.length === 0) {
                alert('‚ùå Nama tidak boleh kosong!');
                return;
            }
            
            if (newName.length > 30) {
                alert('‚ùå Nama maksimal 30 karakter!');
                return;
            }
            
            const relay = relays.find(r => r.id === relayId);
            if (relay) {
                relay.name = newName;
                
                const data = {
                    names: relays.map(r => r.name)
                };
                
                mqttClient.publish(`${TOPIC_PREFIX}/relaynames`, JSON.stringify(data), { retain: true });
                
                renderRelays();
                updateInfoTab();
                
                alert(`‚úÖ Nama Relay ${relayId} berhasil diubah menjadi: ${newName}`);
            }
        }
        
        function saveAllRelayNames() {
            if (!connected) {
                alert('‚ö†Ô∏è Tidak terhubung ke MQTT broker!');
                return;
            }
            
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`relay${i}Name`);
                const newName = input.value.trim();
                
                if (newName.length === 0) {
                    alert(`‚ùå Nama Relay ${i} tidak boleh kosong!`);
                    return;
                }
                
                if (newName.length > 30) {
                    alert(`‚ùå Nama Relay ${i} maksimal 30 karakter!`);
                    return;
                }
                
                relays[i-1].name = newName;
            }
            
            const data = {
                names: relays.map(r => r.name)
            };
            
            mqttClient.publish(`${TOPIC_PREFIX}/relaynames`, JSON.stringify(data), { retain: true });
            
            renderRelays();
            updateInfoTab();
            
            alert('‚úÖ Semua nama relay berhasil disimpan!');
        }
        
        function resetRelayNames() {
            if (confirm('Reset semua nama relay ke default?')) {
                const defaultNames = [
                    'Lampu Ruang Tamu',
                    'Lampu Kamar',
                    'AC',
                    'Kipas Angin'
                ];
                
                relays.forEach((relay, i) => {
                    relay.name = defaultNames[i];
                    document.getElementById(`relay${relay.id}Name`).value = defaultNames[i];
                });
                
                if (connected) {
                    const data = {
                        names: defaultNames
                    };
                    mqttClient.publish(`${TOPIC_PREFIX}/relaynames`, JSON.stringify(data), { retain: true });
                }
                
                renderRelays();
                updateInfoTab();
                
                alert('‚úÖ Nama relay berhasil direset ke default!');
            }
        }
        
        function updateRelayNameInputs() {
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`relay${i}Name`);
                if (input) {
                    input.value = relays[i-1].name;
                }
            }
        }
        
        function updateInfoTab() {
            const infoHtml = relays.map((relay, i) => 
                `‚Ä¢ ${relay.name} (Relay ${relay.id})`
            ).join('<br>');
            
            document.getElementById('infoRelayNames').innerHTML = infoHtml;
        }
        
        // ========== FUNGSI RELAY ==========
        
        function toggleRelay(id) {
            if (!connected) {
                alert('‚ö†Ô∏è Tidak terhubung ke MQTT broker!');
                return;
            }
            
            const relay = relays.find(r => r.id === id);
            if (!relay) return;
            
            const newStatus = !relay.status;
            mqttClient.publish(`${TOPIC_PREFIX}/relay${id}`, newStatus ? 'ON' : 'OFF');
            
            relay.status = newStatus;
            renderRelays();
        }
        
        function editRelayName(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector('.tab[data-tab="settings"]').classList.add('active');
            document.getElementById('settings').classList.add('active');
            
            setTimeout(() => {
                const input = document.getElementById(`relay${id}Name`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }

        function renderRelays() {
            const grid = document.getElementById('relayGrid');
            grid.innerHTML = relays.map(relay => `
                <div class="card relay-card">
                    <div class="relay-header">
                        <div>
                            <div class="relay-name">${relay.name}</div>
                            <div class="relay-label">Relay ${relay.id}</div>
                        </div>
                        <div class="relay-icon ${relay.status ? 'on' : 'off'}">
                            ‚ö°
                        </div>
                    </div>
                    <button class="btn ${relay.status ? 'btn-on' : 'btn-off'}" 
                            onclick="toggleRelay(${relay.id})" 
                            ${!connected ? 'disabled' : ''}>
                        ${relay.status ? '‚óè NYALA' : '‚óã MATI'}
                    </button>
                    <div class="relay-actions">
                        <button class="btn-edit" onclick="editRelayName(${relay.id})">
                            ‚úèÔ∏è Ubah Nama
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ========== FUNGSI JADWAL ==========
        
        function showScheduleModal() {
            const modal = document.getElementById('scheduleModal');
            selectedDays = 127;
            const dayButtons = document.querySelectorAll('.day-btn');
            dayButtons.forEach(btn => btn.classList.add('active'));
            
            const relaySelect = document.getElementById('scheduleRelay');
            relaySelect.innerHTML = '';
            relays.forEach(relay => {
                const option = document.createElement('option');
                option.value = relay.id;
                option.textContent = `${relay.name} (Relay ${relay.id})`;
                relaySelect.appendChild(option);
            });
            
            modal.classList.add('active');
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
        }

        function toggleDay(dayIndex) {
            selectedDays ^= (1 << dayIndex);
            const dayButtons = document.querySelectorAll('.day-btn');
            dayButtons[dayIndex].classList.toggle('active');
        }

        function saveSchedule() {
            if (!connected) {
                alert('‚ö†Ô∏è Tidak terhubung ke MQTT broker!');
                return;
            }

            const schedule = {
                id: Date.now(),
                enabled: true,
                relay: parseInt(document.getElementById('scheduleRelay').value),
                hour: parseInt(document.getElementById('scheduleHour').value),
                minute: parseInt(document.getElementById('scheduleMinute').value),
                action: parseInt(document.getElementById('scheduleAction').value),
                days: selectedDays
            };

            if (schedule.hour < 0 || schedule.hour > 23) {
                alert('‚ùå Jam harus antara 0-23!');
                return;
            }
            
            if (schedule.minute < 0 || schedule.minute > 59) {
                alert('‚ùå Menit harus antara 0-59!');
                return;
            }

            schedules.push(schedule);
            
            const data = {
                schedules: schedules.map(s => ({
                    enabled: s.enabled,
                    relay: s.relay,
                    hour: s.hour,
                    minute: s.minute,
                    action: s.action,
                    days: s.days
                }))
            };
            
            mqttClient.publish(`${TOPIC_PREFIX}/scheduler`, JSON.stringify(data), { retain: true });
            
            renderSchedules();
            closeScheduleModal();
            alert('‚úÖ Jadwal berhasil disimpan!');
        }

        function deleteSchedule(id) {
            if (!confirm('Hapus jadwal ini?')) return;
            
            schedules = schedules.filter(s => s.id !== id);
            
            const data = {
                schedules: schedules.map(s => ({
                    enabled: s.enabled,
                    relay: s.relay,
                    hour: s.hour,
                    minute: s.minute,
                    action: s.action,
                    days: s.days
                }))
            };
            
            mqttClient.publish(`${TOPIC_PREFIX}/scheduler`, JSON.stringify(data), { retain: true });
            
            renderSchedules();
            alert('‚úÖ Jadwal berhasil dihapus!');
        }

        function toggleScheduleEnabled(id) {
            const schedule = schedules.find(s => s.id === id);
            if (schedule) {
                schedule.enabled = !schedule.enabled;
                
                const data = {
                    schedules: schedules.map(s => ({
                        enabled: s.enabled,
                        relay: s.relay,
                        hour: s.hour,
                        minute: s.minute,
                        action: s.action,
                        days: s.days
                    }))
                };
                
                mqttClient.publish(`${TOPIC_PREFIX}/scheduler`, JSON.stringify(data), { retain: true });
                
                renderSchedules();
            }
        }

        function renderSchedules() {
            const list = document.getElementById('scheduleList');
            const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            
            if (schedules.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üïê</div>
                        <p>Belum ada jadwal. Klik "Tambah Jadwal" untuk membuat jadwal baru.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = schedules.map(s => {
                const relay = relays.find(r => r.id === s.relay);
                const relayName = relay ? relay.name : `Relay ${s.relay}`;
                const activeDays = days.filter((_, i) => s.days & (1 << i)).join(', ');
                
                return `
                    <div class="schedule-item">
                        <div class="schedule-info">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <input type="checkbox" 
                                       ${s.enabled ? 'checked' : ''} 
                                       onchange="toggleScheduleEnabled(${s.id})"
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <strong style="font-size: 0.95rem;">${relayName} - ${s.action === 1 ? 'üü¢ Nyalakan' : 'üî¥ Matikan'}</strong>
                            </div>
                            <div style="color: #93c5fd; font-size: 0.85rem;">
                                ‚è∞ ${String(s.hour).padStart(2, '0')}:${String(s.minute).padStart(2, '0')} 
                                | üìÖ ${activeDays}
                            </div>
                        </div>
                        <button class="btn-icon btn-danger" onclick="deleteSchedule(${s.id})" title="Hapus">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ========== FUNGSI CHART ==========
        
        function addTempData(temp) {
            const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            tempData.push({ time, temp });
            if (tempData.length > 20) tempData.shift();
            updateChart();
        }

        function addHumidData(humid) {
            const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            humidData.push({ time, humid });
            if (humidData.length > 20) humidData.shift();
            updateChart();
        }

        function initChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Suhu (¬∞C)',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.15)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'Kelembaban (%)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.15)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            right: 15,
                            bottom: 20,
                            left: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: '#cbd5e1',
                                font: {
                                    size: 12,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#e2e8f0',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: {
                                size: 12,
                                weight: 'normal'
                            },
                            bodyFont: {
                                size: 12
                            },
                            cornerRadius: 8,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(255, 255, 255, 0.08)',
                                drawBorder: false,
                                drawTicks: false
                            },
                            ticks: {
                                color: '#93c5fd',
                                font: {
                                    size: 10,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 8,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            border: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            suggestedMin: 0,
                            suggestedMax: 40,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.08)',
                                drawBorder: false,
                                drawTicks: false
                            },
                            ticks: {
                                color: '#ef4444',
                                font: {
                                    size: 10,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 8,
                                callback: function(value) {
                                    return value + '¬∞C';
                                }
                            },
                            title: {
                                display: false
                            },
                            border: {
                                display: false
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            suggestedMin: 0,
                            suggestedMax: 100,
                            grid: {
                                drawOnChartArea: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#3b82f6',
                                font: {
                                    size: 10,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 8,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: false
                            },
                            border: {
                                display: false
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!tempChart) return;
            
            const labels = tempData.map(d => d.time);
            const temps = tempData.map(d => d.temp);
            const humids = humidData.map(d => d.humid);
            
            tempChart.data.labels = labels;
            tempChart.data.datasets[0].data = temps;
            tempChart.data.datasets[1].data = humids;
            tempChart.update('none');
        }

        // ========== INISIALISASI ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Smart Home Control Initialized');
            
            renderRelays();
            renderSchedules();
            initChart();
            updateInfoTab();
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                });
            });
            
            initMQTT();
            
            setInterval(() => {
                if (!connected) return;
                
                const now = new Date();
                const currentMinute = now.getHours() * 60 + now.getMinutes();
                const currentDay = now.getDay();
                
                schedules.forEach(schedule => {
                    if (schedule.enabled && (schedule.days & (1 << currentDay))) {
                        const scheduleMinute = schedule.hour * 60 + schedule.minute;
                        if (currentMinute === scheduleMinute) {
                            console.log(`‚è∞ Schedule triggered: Relay ${schedule.relay} ${schedule.action === 1 ? 'ON' : 'OFF'}`);
                            mqttClient.publish(`${TOPIC_PREFIX}/relay${schedule.relay}`, 
                                schedule.action === 1 ? 'ON' : 'OFF');
                        }
                    }
                });
            }, 60000);
            
            setInterval(() => {
                if (connected) {
                    mqttClient.publish(`${TOPIC_PREFIX}/requestnames`, 'request');
                }
            }, 30000);
        });

        window.addEventListener('beforeunload', () => {
            if (mqttClient && connected) {
                mqttClient.end();
                console.log('üëã MQTT connection closed');
            }
        });
    </script>
</body>
</html>